# Computer Network

## 6 应用层

应用层协议的特点：

- 应用层的具体内容就是规定应用进程在通信时所遵循的协议
- 应用层的许多协议都是基于客户服务器方式的

### 6.1 域名系统DNS

DNS（Domain Name System）

**域名结构**：

```shell
xxx.三级域名.二级域名.顶级域名

顶级域名后还有一个点（根域名）
```

**域名服务器**

- 一个服务器所负责管辖的（或有权限的）范围叫做取（Zone）
- 每一个Zone中设置相应的权限域名服务器，用来保存该区中的所有主机的域名到IP地址的映射
- DNS服务器的管辖范围不是以“域”为单位的，而是以“区”为单位的

作用：

- 负责解析域名将域名解析成IP

Windows系统中查看域名对应主机IP的方法：

```shell
nslookup
```

**域名的解析过程：**

- 主机向本地域名服务器的查询一般都是采用递归查询。如果主机所询问的本地域名服务器不知道被查询域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其他根域名服务器继续发出查询请求报文
- 本地域名服务器向根域名服务器的查询通常是采用迭代查询，当根域名服务器收到本地域名服务器的迭代查询请求报文时，要么给出所要查询的IP地址，要么告诉本地域名服务器：“你下一步应当向哪一个域名服务器进行查询”。然后让本地域名服务器进行后续的查询
- 维护域名到IP的映射缓存来提高访问速度，绑定有效的存在时间来确保访问的准确性

### 6.2 文件传送协议FTP（File Transfer Protocol）

- FTP 提供交互式的访问，允许客户指明文件的类型和格式，并允许文件具有存取权限
- FTP 屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件

**FTP 的基本工作原理**

- FTP只提供文件传送的一些基本的服务，它使用TCP可靠的运输服务
- FTP的主要功能是减少或消除在不同操作系统下处理文件的不兼容性
- FTP使用客户服务器的方式。一个FTP服务器进程可同时为多个客户进程提供服务。FTP的服务器进程由两大部分组成：一个主进程，负责接受新的请求；另外有若干个从属进程，负责处理单个请求
  
**主进程工作步骤如下**：

- 打开熟知端口（端口号为21），使客户进程能够连接上
- 等待客户进程发出连接请求
- 启动从属进程来处理客户进程发来的请求。从属进程对客户进程的请求处理完毕后即终止，但从属进程在运行期间根据需要还可能创建其他一些子进程
- 回到等待状态，继续接收其他客户进程发来的请求。主进程与从属进程的处理是并发地进行的。

**两个连接**：

- *标准端口：21* 控制连接在整个会话期间一直保持打开，FTP客户发出的传送请求通过控制连接发送给服务器端的控制进程，但控制连接不用来传送文件
- *标准端口：20* 实际用于传输文件的是“数据连接”。服务器端的控制进程在接受FTP客户发送来的文件传输请求后就创建“数据传输进程”和“数据连接”，用来连接客户端和服务器端的数据传送进程
- 数据传送进程实际完成文件的传送，在传送完毕后关闭“数据传送连接”，并结束运行

**两个端口号**：

- 当 Client 进程向服务器进程发出建立连接请求时，要寻找连接服务器进程的熟知端口（21），同时还要告诉 Server 进程的自己的另一个端口号码，用于建立数据传送连接
- 接着，Server 进程用自己传送数据的熟知端口（20）与客户进程所提供的端口号码建立数据传送连接
- 由于FTP使用了两个不同的端口号，所以数据连接与控制连接不会发生混乱
- 这样仅仅开放 port 20 与 21 即可穿透防火墙

### 6.4 万维网 WWW

- World Wide Web 是分布式超媒体（hypermedia）系统，它是超文本（hypertext）系统的扩充。
- 一个 ht 由多个信息源链接组成，利用一个连接可以使用户找到另一个文档，这些文档可以位于世界上任何一个接在因特网上的超文本系统中。超文本是万维网的基础
- 超媒体与超文本的区别是文档内容不同。超文本文档仅包含文本信息，而超媒体文档还包含其他表示方式的信息，如图形，图像，声音，动画甚至活动视频图像。
 
**统一资源定位符URL（Unit Resource Locator）**

- URL 给资源的位置提供了一种抽象的识别方法，并用这种方法给资源定位
- 只要能够对资源定位，系统就可以对资源进行存取，更新，替换和查找其属性
- URL 是与因特网相连的机器上的任何可访问对象的一个指针

**URL的一般形式**

- 由以冒号隔开的两大部分组成，并且在URL中的字符对大写或小写没有要求
- 一般形式

```shell
<协议>://<主机>:<端口>/<路径>

协议:ftp 文件传送协议 FTP
     http 超文本传送协议 HTTP
     News USENET新闻
主机:主机是存放资源的主机在因特网中的域名
* 端口和路径有时可以省略，默认端口80，默认路径可设置
```
**万维网的工作过程**

```shell
|Client         Server|
=======================
|-----建立TCP连接------|
|>>>>>HTTP请求报文>>>>>|
|<<<<<HTTP响应报文<<<<<|
|-----释放TCP连接------|
```

**代理服务器**（proxy server）

- proxy server 又称万维网高速缓存（Web cache），它代表浏览器发出 HTTP 请求
- 万维网高速缓存把最近的一些请求和响应暂存在本地磁盘中
- 当与暂存的请求相同的新请求到达时，万维网高速缓存就把暂存的相应发送出去，而不需要按URL的地址再去因特网访问该资源
  
**使用 Proxy Server 的好处**

- 节省内网访问Internet的带宽
- 使用Web 代理服务器绕过防火墙
- 可以避免跟踪，顺藤模瓜

**HTTP的报文结构**

HTTP有两类报文：

- 请求报文：从客户向服务器发送请求报文
- 响应报文：从服务器向客户的回答
- 由于HTTP是面向正文（text-oriented），因此在报文中的每一个字段都是一些ASCII码串，且长度都是不确定的

**请求报文结构**

- 报文由三个部分组成，即开始行，首部行，和实体主体。在请求报文中，开始行就是请求行。
- CRLF （Carrierage-return & Line-Feed）换行回车（`"/r/n"`）

|        行数        |                   结构                    |
| ------------------ | ----------------------------------------- |
| 1 开始行（请求行） | （方法）space（URL）space（版本）（CRLF） |
| 2 首部行           | （首部字段名）colon+space（值）CRLF       |
| 3 重复首部行       | （首部字段名）colon+space（值）CRLF       |
| 4                  | CRLF                                      |
| 5 通常不用         | 实体主体                                  |

- 方法是对所请求对象进行的操作，因此方法也就是一些命令，请求报文的类型是由它所采用的方法决定的
- “版本”是HTTP的版本

**HTTP请求报文的方法**

| 方法（操作） |              意义               |
| ------------ | ------------------------------- |
| OPTION       | 请求一些选项的信息              |
| GET          | 请求读取有URL所标志的信息       |
| HEAD         | 请求读取由URL所标志的信息的首部 |
| POST         | 给服务器添加信息（例如：注释）  |
| PUT          | 在指明的URL下储存一个文档       |
| DELETE       | 删除指明的URL所标志的资源       |
| TRACE        | 用来进行回环测试的请求文本      |
| CONNECT      | 用于代理服务器                  |

**HTTP的响应报文结构**

|        行数        |                   结构                   |
| ------------------ | ---------------------------------------- |
| 1 状态行           | （版本）space（状态码）space（短语）CRLF |
| 2 首部行           | （首部字段名）colon+space（值）CRLF      |
| 3 重复首部行       | （首部字段名）colon+space（值）CRLF      |
| 4                  | CRLF                                     |
| 5 有些响应报文不用 | 实体主体                                 |

- 状态行包括三项内容：HTTP 版本；状态码；解释状态码的简单短语

状态码都是三位数字：

- 1xx 表示通知信息的，如请求收到了或正在进行处理
- 2xx 表示成功，如接受或知道了
- 3xx 表示重定向，表示要完成请求还必须采取进一步的行动（例如：资源位置更换了，新的资源位置就会被放在头部）
- 4xx 表示客户的差错，如请求中有错误的语法或不能完成
- 5xx 表示服务器的差错，如服务器失效无法完成请求

**在服务器上存放用户信息：**

- 万维网站点使用 Cookie 来跟踪用户
- Cookie 表示在 HTTP Server 和 Client 之间传递的状态信息
- 使用 Cookie 的 Client 为用户产生一个唯一的识别码。利用此识别码，网站就能跟踪该用户在网站的活动

**通用网关接口 CGI(Common Gateway Interface)**

- CGI 是一种标准，它定义了动态文档应如何创建，输入数据应如何提供给应用程序，以及输出结果应如何使用
- 万维网服务器与CGI的通信遵循CGI标准
- “通用”：CGI标准所定义的规则对其他任何语言都是通用的
- “网关”：CGI程序的作用像网关
- “接口”：有一些已定义好的变量和调用等可提供其他CGI程序使用

CGI程序严格意义上是是CGI脚本（script）

- 脚本指的是一个程序，它被另一个程序（解释程序）而不是计算机的处理机来解释或执行
- 脚本运行起来要比一般的编译程序要慢，因为它每一条指令都要先被另一个程序来处理（这就要另一个附加指令），而不是直接被指令处理器来处理

**浏览器的结构**

- 控制程序：核心部件，解释鼠标的点击和键盘的输入，并调用有关的组件来执行用户指定操作
- 解释程序：维持一个指令指针，在初始化时，指在小应用程序的开始处，在每一次循环操作时，解释程序在指令指针指向的地址读取字节码。然后解释程序对字节码进行解码，并完成指明的操作
- 缓存：浏览器将它取回的每一个页面副本都放入本地磁盘的缓存中；当用户用鼠标点击某个选项时，浏览器首先检查磁盘的缓存。若缓存中保存了该项，浏览器就直接从缓存中得到该项的副本而不必从网络获取，这样就明显地改善了浏览器的运行特性

### 6.5 电子邮件

- 发送邮件的协议： SMTP（Simple Message Transfer Protocol）
- 读取邮件的协议： POP3 和 IMAP
- MIME在其邮件首部中说明了邮件的数据类型（如文本，声音，图像，视频等）

一个SMTP邮件服务器既可以作为客户也可以作为服务器，当A向B发送邮件时，A是Server，当B向A发送邮件时，A是Client

**发送和接收电子邮件的几个重要步骤**

- 1 发件人调用PC机中的用户代理撰写和编辑要发送的邮件
- 2 发件人的用户代理把邮件用SMTP协议发给发送方邮件服务器
- 3 SMTP服务器把邮件临时存放在邮件缓存队列中，等待发送
- 4 发送方邮件服务器的SMTP客户与接收方邮件服务器的SMTP服务器建立TCP连接，然后就把邮件缓存队列中的邮件依次发送出去
- 5 运行在接受方邮件服务器中的SMTP服务器进程收到邮件后，把邮件放入收件人的用户邮箱中，等待收件人进行读取
- 6 收件人在打算收信时，就运行PC机中的用户代理，使用POP3（或IMAP）协议读取发送给自己的邮件

注意：POP3 Server 和 POP3 Server 之间的通信是由POP3客户发起的

**MIME特点：**

- MIME没有改动SMTP或取代它
- MIME的意图是继续使用目前[RFC 822]格式，但增加了邮件主体的结构，并定义了传送非ASCII码的编码规则

#### Python邮件收发协议编程

[廖雪峰的Python教程](https://www.liaoxuefeng.com/wiki/1016959663602400/1017790556023936)

### 6.6 动态主机配置协议DHCP（Dynamic Host Configuration Protocol）

- 为了将软件协议做成通用的和便于移植，协议软件的编写者把协议软件参数化。这就使得在很多台计算机上使用同一个经过编译的二进制代码成为可能
- 在软件协议运行之前，必须该每一个参数赋值
- DHCP提供了即插即用连网（Plug-and-play networking）的机制
- 允许一台计算机加入新的网络时，自动获取IP地址

**协议配置**

- IP地址
- 子网掩码
- 默认路由器的IP地址
- 域名服务器的IP地址

**DHCP工作过程**

- 需要IP地址的主机在启动时就向DHCP服务器广播发送发现报文（DHCPDISCOVER），这时该主机就成为DHCP客户
- 本地网络上所有主机都能收到此广播报文，但只有DHCP服务器才回答
- DHCP服务器先在其数据库中查找该计算机的配置信息。若找到，则返回找到的信息。若找不到，则从服务器的IP地址池中取一个地址分配给该计算机。DHCP服务器的回答报文叫做提供报文（DHCPOFFER）

**DHCP中继代理**（relay agent）

- 不是每一个网络上都有DHCP服务器，这样会使DHCP服务器的数量太多。现在是每一个网络至少有一个DHCP中继代理，它配置了DHCP服务器的IP地址信息
- 当DHCP中级代理收到主机广播的报文之后，就以单播的方式向DHCP服务器转发报文，并将其回答的报文转发给主机
- DHCP报文只是UDP用户数据报中的数据

**租用期**（lease period）

- DHCP服务器分配给DHCP客户的IP地址是临时的，因此DHCP客户智能在一段有限的时间内使用这个分配到的IP地址。DHCP协议称这段时间为租用期
- 租用期的数值应由DHCP服务器自己决定
- DHCP客户也可以在自己发送的报文中（例如发现报文）提出对租用期的要求

**DHCP协议的工作过程**

- 1 DHCP服务器被动打开 UDP端口 67，等待 client 发来的报文
- 2 DHCP Client 从 UDP 端口 68 发送 DHCP 发现报文（DHCPDISCOVER）
- 3 凡收到DHCP发现报文的DHCP服务器都发出DHCP提供报文，因此DHCP客户可能收到多个DHCP提供报文
- 4 DHCP客户从几个DHCP服务器中选择其中的一个，并向所选择的DHCP服务器发送DHCP请求报文
- 5 被选择的DHCP服务器发送确认报文DHCPACK，进入已绑定状态，并可以开始使用得到的临时IP地址了
- 6 DHCP Client 现在要根据服务器提供的租用期T设置两个计时器 T1（0.5T） 和 T2（0.875T）
-   租用期达到 T1 ，DHCP CLient 发送请求报文 DHCPREQUEST 要求更新租用期
- 7 DHCP Server 若同意，则发回确认报文DHCPACK。DHCP Client 得到了新的租用期，重新设置计时器
- 8 DHCP Server 若不同意，则发回确认报文 DHCPNACK 这时DHCP客户必须立即停止使用原来的IP地址，并且回到步骤2 重新申请IP地址
-   若 DHCP Server 不响应步骤 6 的请求报文 DHCPREQUEST，则在租用期达到 T2 时， DHCP Client 必须重新发送请求报文 DHCPREQUEST（重复步骤 6 ）
- 9 DHCP Client 可随时提前终止 Server 所提供的租用期，这时只需要向 DHCP 服务器发送释放报文 DHCPRELEASE 即可

**DHCP(Dynamic Host Configuration Protocol)工作过程图解**

```shell
DHCP-Client                  DHCP-Server
========================================
                    <------UDP67 被动打开
UDP68-------DHCPDISCOVER---------->UDP67
UDP68<--------DHCPOFFER------------UDP67
UDP68------- DHCPREQUEST---------->UDP67
UDP68<---------DHCPACK-------------UDP67
                  .
UDP68--------DHCPREQUEST---------->UDP67
                  .
```

### 6.8 应用进程跨越网络的通信

#### 系统调用和应用编程接口

- 大多数操作系统使用系统调用（System Call）的机制在应用程序和操作系统间传递控制权
- 系统调用与函数调用类似，只不过系统调用是将控制权传递给了系统

**API（Application Programming Interface）**

- 当某个应用进程启动系统调用时，控制权就从应用进程传递给了系统调用接口
- 此接口再将控制权传递给操作系统，操作系统将此调用转给某个内部过程，并执行所请求的操作
- 内部过程一旦执行完毕，控制权就又通过系统调用接口返回给应用进程
- 系统调用接口实际上就是应用进程的控制权和操作系统的控制权的一个接口，即应用编程接口

**Socket的作用**

- 当应用进程需要使用网络进行通信时就发出系统调用，请求操作系统为其创建“套接字”，以便把网络通信所需要的系统资源分配给该应用系统
- 操作系统为这些资源的总和用一个套接字描述符的号码来表示，并把此号码返回给应用进程。应用进程所进行的网络操作都必须使用这个号码
- 通信完毕后，应用进程通过一个关闭套接字的系统调用通知操作系统回收与该“号码”相关的所有资源

#### 几种常见的系统调用

**连接建立阶段**

- 当套接字被创建后，它的端口号和IP地址都是空的，因此应用进程要调用bind（绑定）来指明套接字的本地地址。在服务器端调用bind时就是把熟知的端口号和本地IP地址填写到已创建的套接字中，这就叫做把本地地址绑定到套接字
- 服务器在调用bind后，还必须调用listen（收听）把套接字设置为被动方式，以便随时接受客户的服务请求，UDP服务器由于只提供无连接服务，不使用 listen 系统调用
- 服务器紧接着就调用accept（接受），以便把远地客户进程发来的连接请求提取出来。系统调用accept的一个变量就是要指明从哪一个套接字发起的连接

### Python 网络编程

[廖雪峰的Python网络编程](https://www.liaoxuefeng.com/wiki/1016959663602400/1017788916649408)