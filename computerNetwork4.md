# Computer Network

## 4 网络层

**复习：**

物理层：

- 网络设备的机械特性；电气特性；功能特性；过程特性
- 数据通信的基础知识
  - 数字信号
  - 模拟信号
-频分多路复用
-时分多路复用

数据链路层：

- 封装成帧：区分传输的数据段
- 透明传输：转义符的应用
- 差错检验：循环冗余检验

点到点的数据链路层 PPP
广播信道的数据链路层 CSMA/CD

以太网 集线器 网桥 交换机 100 1000 10000M 以太网

网络层：

- 负责在不同的网络之间尽力转发数据包
- 基于数据包的IP地址转发
- 不负责丢失重传

**网络层提供的服务：**

- 网络层协议
- 网络层如何转发数据包
- 网络设备
- IP协议：RIP；OSPF
- ARP协议
- 网际控制报文协议 ICMP
- Internet组播管理协议 IGMP
- IP数据报格式
- IP层转发分组的流程

采用面向连接的通信方式：

- 建立虚拟电路，以保证双方通信所需的一切网络资源
- 如果再使用可靠船速的通信协议，就可以保证所发送的分组无差错按序到达终点。

通信设备：

- 集线器：物理层设备（一层设备），传输“Bit”流，作用是延长网线长度
- 交换机：数据链路层设备（二层设备），收到“Bit”流，看目标MAC地址（选择出口）
- 路由器：网络层设备（三层设备），可以读懂IP地址，传送时会逐层封装，解封传送。

### 地址解析协议ARP

Address Resolution Protocol

- ARP是解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题
- 如果所要找的主机和源主机不在同一个局域网上，那么就要通过ARP找到一个位于本层局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络，剩下的工作由下一个网络来做
  
如果计算机网络中同一网段中的所有计算机都知道对方的MAC地址，那么就不需要ARP协议

**ARP欺骗**：

中间人：

- 当M4到M1通信的时候，首先M4会在全网段内广播，得到M1的回应并记录M1的MAC地址。
- M2也会收到广播，迅速发送一个MAC地址，覆盖掉M4记录的MAC地址
- 这样所有传输给M1的数据全部会转发给M2，再经由M2转发给M1

执行官：

- 覆盖掉通信的某一方的MAC地址，达到阻止两者通信的目的

P to P终结者：

- 覆盖掉网关或路由的地址，阻止计算机和外网通信

ARP欺骗造成的网络不通是数据链路层故障

```
arp -a        #查看所有的arp协议捕获的地址缓存，在本地连接-修复（清除缓存）

arp -s IP MAC #静态绑定路由器或IP的MAC地址

.mat          #Windows下的执行脚本，如果放在组编辑器的执行策略中就会开机自动执行
```

### 网际控制报文协议ICMP

Internet Control Message Protocol

- 为了提高IP数据报交付成功的机会，在网际层使用ICMP协议
- 允许主机或路由器报告差错情况和提供有关异常情况的报告
- ICMP不是高层协议，而是IP层协议
- ICMP报文作为IP层数据报的数据，加上数据报的首部，组成IP数据报发送出去

**ICMP报文的种类：**

- ICMP报文的种类有两种，即ICMP差错报告报文和ICMP询问报文
- ICMP报文的前4个字节是统一的格式，共有三个字段：即类型代码和检验和。接着的4个字节的内容与ICMP的类型有关

ICMP差错报告报文共有5种：

- 终点不可达
- 源点抑制（Source quench）
- 时间超过
- 参数问题
- 改变路由（Redirect重定向）

不应发送ICMP差错报文的几种情况

- 对ICMP差错报告报文不再发送ICMP差错报告报文
- 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
- 对具有多播地址的数据报都不发送ICMP差错报告报文
- 对具有特殊地址（如 127.0.0.0 或 0.0.0.0）的数据报不发送ICMP差错报文

ICMP询问报文有两种

- 回送请求和回答报文
- 时间戳请求和回答报文

#### ICMP应用举例

- Ping 用来测试两个主机之间的连通性
- Ping 使用ICMP回送请求与回送回答报文
- Ping 是应用层直接使用网络层ICMP的例子，它没有通过运输层的TCP或UDP

**Ping命令的使用**：

```shell
ping + 选项 + IP
```

| 选项 | 后续内容 |         作用         |
| ---- | -------- | -------------------- |
| `-t` | numbers  | ping hosts           |
| `-i` | 生存时间 | 指定发送包的生存时间 |
| `-l` | size     | 指定发送数据大小     |

默认的TTL（Time To Live）
|   系统    | 数据 |
| --------- | ---- |
| `Linux`   | 64   |
| `Windows` | 128  |
| `Unix`    | 255  |

```shell
pathping + IP
```

记录所有到达目标地址经过的路由（Windows系统自带的功能）

```
traceroute + IP
```

记录所有到达目标地址经过的路由（Linux系统自带的功能）

### 网际组管理协议IGMP和多播路由选择协议

IGMP （Internet Group Management Protocol）

- 用于向多个IP地址同时传输数据

### 虚拟专用网络VPN和网络地址转换NAT

- 本地地址：仅在机构内部使用的IP地址，可以由本机构自行分配而不需要向因特网管理机构申请
- 全球地址：全球唯一的IP地址，必须向因特网的管理机构申请

**RFC1918**指明的专用地址（private address）

- 10.0.0.0 ~ 10.255.255.255
- 172.16.0.0 ~ 172.31.255.255
- 192.168.0.0 ~ 192.168.255.255

利用隧道技术实现虚拟专用网络

- 远程接入VPN

网络地址转换NAT
（Network Address Translation）

- 1994年提出
- 需要在专用网连接到因特网的路由器上安装NAT软件，装有NAT的路由器至少有一个有效的外部全球地址：IPg
- 所有使用本地地址的主机在和外界通信时都要在NAT路由器上将其本地地址转为IPg才能和因特网连接

网络地址转换过程：

- 内部主机X用本地地址IPx和因特网上主机Y通信所发送的数据报必须经过NAT路由器
- NAT路由器将数据报的源地址IPx转换成全球地址IPg但是IPy保持不变，然后进行传输
- NAT路由器收到主机Y发回的数据报时，知道数据报中的源地址是IPy而目的地址是IPg
- 根据NAT转换器表，NAT路由器将目的地址IPg转换为IPy，转发给最终的内部主机X

### IP数据报文的结构

首部（固定部分20字节 + 可变长度） + 数据报

**IP数据报首部固定部分详解**

|     字段     |  位数   |                                                                                   说明                                                                                    |
| ------------ | ------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 版本         | 4 bits  | 目前为4（IPV4）                                                                                                                                                           |
| 首部长度     | 4 bits  | 最大数值为15单位（一个单位4字节）因此IP地址的首部长度最大是60字节                                                                                                         |
| 区分服务     | 8 bits  | 一般不使用                                                                                                                                                                |
| 总长度       | 16 bits | 首部 + 数据报的长度，数据报最大长度是65535 bytes                                                                                                                          |
| 标识         | 16 bits | 一个计数器，用来产生数据报的标识                                                                                                                                          |
| 标志（flag） | 3 bits  | 目前只有前两位有意义，最低位是 MF（More Fragment）。MF = 1 表示后面 “还有分片”。MF = 0 表示最后一个分片；标志字段中间的一位是DF（Don't Fragment）。只有当DF=0时才允许分片 |
| 片偏移       | 13 bits | 较长的分组在分片后，某片在原分组中的相对位置，片偏移以8个字节为偏移单位                                                                                                   |
| 生存时间     | 8 bits  | TTL（time to live）数据报在网络中可通过的路由器数的最大值                                                                                                                 |
| 协议         | 8 bits  | 指出数据报携带的数据使用何种协议以便目的主机的IP层将数据报部分上交给哪个处理过程（ICMP：1；IGMP：2；TCP：6；UDP：17；IPV6：41；OSPF：89）                                 |
| 首部检验和   | 16 bits | 只检验数据报的首部不检验数据部分，这里不采用CRC检验码而采用简单的加法计算                                                                                                 |
| 源地址       | 4 bits  | 发送主机的IP                                                                                                                                                              |
| 目标地址     | 4 bits  | 接收主机的IP                                                                                                                                                              |

**IP数据报可变部分**

- 是一个可选字段，用来支持排错，测量，以及安全等措施，内容很丰富
- 选项字段的长度可变，从1字节到40字节不等，取决于所选择的项目
- 增加首部的可变部分是为了增加IP数据报的功能，但这同时也使得IP数据报的首部长度成为可变的。这就增加了每一个路由器处理数据报的开销
- 实际上这些选项很少被使用

**泪滴攻击**

| 所处层数 |      数据报极限大小       |
| -------- | ------------------------- |
| 网络层   | 65535 bytes               |
| 链路层   | 500 bytes（最大传输单元） |

- 数据报如果不分片最大不超过480字节（网络层固定首部20字节）
- 攻击者可以发送不完整的分片数据报，让计算机一直处于等待状态
- 向目标机器发送损坏的IP包，诸如重叠的包或过大的包荷载，凭借这些手段，该攻击可以通过TCP/IP协议栈中分片重组代码中的bug来瘫痪各种不同的操作系统

### IP层转发分组的流程

- 路由表中储存的是主机所在的网络地址
- 根据目的的网络地址就能确定下一跳路由器，这样做的结果是：
- IP数据报最终一定可以找到目的的主机所在目的网络上的路由器（可能要通过多次间接交付）
- 只有到达最后一个路由器时，才试图向目的主机进行直接交付

**分组转发算法**

- 1）从数据报的首部提取目的主机IP地址D，得出目的的网络地址为N
- 2）若路由表中有目的地址为D的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器；否则执行4
- 3）若路由表中有到达网络N的路由，则把数据报传送给路由表中指明的下一跳路由，否则执行5
- 4）若路由表中有到达网络N的路由，则把数据报传送给路由表指明的吓一跳路由器；否则，执行5
- 5）若路由表中有一个默认路由器，则把数据报传送给路由表中所指明的默认路由器；否则，执行6
- 6) 报告转发分组出错

### 划分子网和构造超网

因特网由ICANN(Internet Corporation for Assigned Names and Numbers)进行分配

**分类的编址方法**

- `IP={<网络号> + <主机号>}`

| 地址类别 | 标识符 |     net-id     | host-id  |
| -------- | ------ | -------------- | -------- |
| A类      | `0`    | 8 bits         | 24 bits  |
| B类      | `10`   | 16 bits        | 16 bits  |
| C类      | `110`  | 24 bits        | 8 bits   |
| D类      | `1110` | 多播地址       | 多播地址 |
| E类      | `1111` | 保留为今后使用 | 保留     |

**常用的三种类别的IP地址**

| 网络类别 |    最大网络数     | 第一个可用的网络号 | 最后一个可用的网络号 | 每个网络中最大的主机数 |                              备注                              |
| -------- | ----------------- | ------------------ | -------------------- | ---------------------- | -------------------------------------------------------------- |
| A类      | `126`(2^7-2)      | 1                  | 126                  | `16777214`(2^24-2)     | 网络号中首位必须是0，且全是0和全是1的要保留（全1用作广播地址） |
| B类      | `16383`(2^14-1)   | 128.1              | 191.255              | `65534`(2^16-2)        | 网络号首位必须是10                                             |
| C类      | `2097151`(2^21-1) | 192.0.1            | 223.255.255          | `254`(2^8-2)           | 网络号中首位必须是110                                          |

**IP地址的重要特点**

- IP地址是标志一个主机（或路由器）和一条链路的重要接口
- 当一个主机同时连接到两个网络上时，该主机就必须同时具有两个相应的IP地址，其网络号net-id必须是不同的。这种主机称为多归属主机（multihomed host）
- 一个路由器至少应当连接到两个网段，因此一个路由器至少应当有两个不同的IP地址
- 用转发器或网桥连接起来的若干个局域网仍为同一个网络，具有相同的net-id
- 所有分配到网络号net-id的网络，范围很小的局域网，还是可能覆盖很大的地理范围的广域网，都是平等的。

**二级IP地址**

- 每台物理机都有一个专属IP（网络部分和主机部分）
- 物理机之间可以像局域网一样彼此访问连接
- IP空间利用率很低
- 路由表太大因而使网络性能被破环
- 两级IP地址不够灵活
- 两级IP地址数量有限（宝贵资源）

**三级IP地址（划分子网）**

- 从主机号借用若干个单位作为子网号 subnet-id, 而主机号 host-id 也就相应减少了若干个位
- `IP地址={<网络号> + <子网号> + <主机号>}`
- 一定程度上缓解了两级IP地址的枯竭问题
- A B C 三类两级地址已经可以辨别42亿的三倍数量的主机
- 三级地址按照划分方法的数量可以在这个数字上再乘几倍
- 所谓的IP地址枯竭，是一个已经不是问题的问题了

**划分子网的基本思路**

- 凡是从其他网络发送给本单位某个主机的IP数据报仍然是根据IP数据报的net-id，先找到连接到本单位网络的路由
- 然后此路由在收到IP数据报后，再按照目的net-id和子网subnet-id找到目的子网
- 最后就将IP数据报直接交付目的主机
- 使用子网掩码（subnet mask）可以找出IP地址中的子网部分
- IP地址和子网掩码进行与运算得到net-id

**子网掩码的重要属性**

- 路由器在和相邻路由器交换路由信息时，必须把自己所在网络（或子网）的子网掩码告诉相邻路由器
- 路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该网络的子网掩码
- 若一个路由器连接在两个子网上就拥有两个网络地址和两个子网掩码
- 不同的子网掩码可以得出“点分十进制”相同的网络地址，但是二进制表示是不同的，代表着不同的网络

**使用子网掩码的分组转发过程**
- **问题**：IP数据报首部只有IP地址信息，却没有子网掩码信息
- **解决方法**：分组转发算法进行改进，在路由表中匹配子网掩码信息

### 无分类编址 CIDR
CIDR（Classless Inter-Domain Routing）
- 可以充分利用IP地址资源，根据服务规模的大小自行选择网络号前缀
- `IP={<网络前缀> + <主机号>}`

举例：

- 128.14.32.0/20
- 简称为“/20地址块”
- 最小地址：128.14.32.0
- 最大地址：128.14.47.255（全1的地址一般是广播地址）

**路由聚合**
route aggregation

- 一个CIDR地址块可以表示很多地址，这种地址的聚合常常称为路由聚合，它使得路由表中的一个项目可以表示很多个（上千个）原来传统分类地址的路由
- 路由聚合也称为构成超网（supernetting）

**最长前缀匹配**

- 选择两个匹配的地址中更具体的一个，即选择最长前缀地址
- 这么做的目的显而易见，我想找一个叫李刚的人，显然是描述的越具体，找的越准

**使用二叉线索查找路由表**

### 因特网的路由选择协议

配置路由的6字真言：数据有来有回

静态路由选择策略：
- 需要告诉路由所有没有直连的网络下一跳给谁
- 适合于小的网络，不能自动调整路由

**自治系统AS**
AS（Autonomous System）

- 尽管一个AS使用了多种内部路由选择协议和度量，但重要的是一个AS对其他AS表现出的是一个单一的和一致的路由选择策略。

**两大路由选择协议**

- 内部网关协议 IGP（Interior Gateway Protocol）在一个AS内部使用的路由选择协议，目前这类路由选择协议使用的最多，如RIP和OSPF协议

- 外部网关协议 EGP（External Gateway Protocol）AS之间的协议，在外部网关协议中目前使用最多的是BGP-4

RIP（Routing Information Protocol）是一种IGP（Interior Gateway Protocol），只会选择最短路径，最大跳数不超过16，只适用于小型的AS。

OSPF（Open Shortest Path First）分布式链路状态协议，直接用IP数据报传送，且可以有效维护多路径间的负载平衡。

BGP（Border Gateway Protocol）采用 border gateway speaker 的方式，达到网络间通信的目的，其选择的并非最优路线，而是一条可行路线。