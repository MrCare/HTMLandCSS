# Computer Network

## 3 数据链路层

数据链路层使用的信道主要有以下两种类：

- 点对点信道：这种信道使用一对一的点对点通信方式。

- 广播信道：这种信道使用一对多的广播通信方式，因此过程比较复杂。广播信道上连接的主机很多，因此必须使用专用的共享信道协议来协调这些主机的数据发送

### 3.1 使用点对点信道的数据链路层

#### 3.1.1 数据链路和帧

**链路(link)** 是一条无源的点到点的物理线路段，中间没有任何其他的交换结点。

- 一条链路只是一条通路的一个组成部分。

**数据链路(data link)** 除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路。

- 现在最常用的方法是使用适配器（即网卡）来实现这些协议的硬件和软件。

- 一般的适配器都包括了数据链路层和物理层这两层的功能。

#### 3.1.2 三个基本问题

- 封装成帧

- 透明传输

- 差错控制

**PPP协议**：点对点协议（Point to Point Protocol）用户使用拨号电话线接入因特网时，一般都是使用PPP协议

**PPP协议满足的要求**：

- 简单

- 封装成帧

- 透明性

- 多种网络层协议

- 多种类型链路

- 差错检测

- 检测连接状态

- 最大传送单元

- 网络层地址协商

- 数据压缩协商

**PPP协议不需要满足的要求**：

- 纠错

- 流量控制

- 序号

- 多点线路

- 半双工或单工链路

**PPP协议的组成**：

- 数据链路层协议可以用于异步串行或同步串行介质

- 它使用LCP（Link control protocol）建立并维护数据链路连接（身份验证和计费功能）

- NCP（Network control protocol）允许在点到点连接上使用多种网络层协议

**PPP协议帧格式**：

- `7E + FF + 03 + 协议 + 信息部分（不超过1500字节） + FCS + 7E`

| 协议字段 | 含义                          |
| -------- | ----------------------------- |
| 0x0021   | ppp协议的信息字段就是IP数据报 |
| 0xC021   | 信息字段就是ppp链路控制数据   |
| 0x8021   | 表示这是网络控制数据          |
| 0xC023   | 信息字段是安全性认证PAP       |
| 0xC025   | 信息字段是LQR                 |
| 0xC223   | 信息字段是安全性认证CHAP      |

### 3.2 使用广播信道的数据链路层

#### 3.2.1 共享通信媒体

静态划分信道方法（麻烦）：

- 频分复用

- 时分复用

- 波分复用

- 码分复用

动态媒体接入控制（多点接入）：

- 随机接入 （主要被以太网采用）
  - 主机A将发给B的数据广播出去，B接受，其他主机不理会（安全性差）

- 受控接入 （polling 已经不被采用 ）

载波监听多点接入/碰撞检测 以太网使用CSMA/CD协议：

`CSMA/CD`表示 Carrier Sense Multiple Access with Collision

- “多点接入”：表示许多计算机以多点接入的方式连接在一根总线上

- “载波监听”：是指每一个站在发送数据之前先要检测一下总线上是否有其他计算机在发送数据，如果有，则暂时不要发送数据，以免发生碰撞，所谓载波监听，就是用电子技术检测总线上有没有其他计算机发送的数据信号

**碰撞检测**：就是计算机发送数据边检测信道上的信号电压大小

- 当几个站同时在总线上发送数据时，总线上的信号电压摆动值将会增大（互相叠加）

- 当一个站检测到的信号电压摆动值超过一定的门限值时，就认为总线上至少有两个站同时在发送数据，表明产生了碰撞

- 所谓“碰撞”就是发生了冲突，因此“碰撞检测”也称为“冲突检测”

**检测到碰撞后**

- 在发生碰撞时，总线上传输的信号产生了严重的失真，无法从中恢复出有用的信息

- 每一个正在发送数据的站，一旦发现总线上出现了碰撞，就要立即停止发送，免得继续浪费网络资源，然后等待一段随机时间后再次发送

**对载波监听的影响**

- 当某个站监听到总线是空闲的时候，可能总线并非真正是空闲的

- 传播时延会对载波监听产生影响

- 使用 CSMA/CD 协议的以太网不能进行全双工通信，而只能进行双向交替通信（半双工通信）

- 每个站在发送数据之后的一小段时间内，存在着遭遇碰撞的可能性。

- 这种发送的不确定性使整个以太网的平均通信量远小于以太网的最高数据率

**征用期**

- `2t`时间（两倍的端到端往返时延），经过征用期这段时间还没有检测到碰撞，才能肯定这次发送不会发生碰撞

**二进制指数类型退避算法**（truncated binary exponential type）

`k = Min[重传次数, 10]`

**最短有效帧长**

- 对于`10Mb/s`以太网，在征用期内可发送512bit，即64字节

- 若前64字节没有发生冲突，则后续的数据就不会发生冲突

- 以太网网线不可以超过100M，因为如果超过了会影响冲突检测

**MAC层的硬件地址（MAC地址）**

- 在局域网中，硬件地址又称为物理地址，或MAC地址

- 由48位二进制组成

- IEEE 的注册管理机构RA负责向厂家分配地址字段的前三个字节（即高位24位）

- 地址字段中的后三个字节（即低位24位）由厂家自行指派，称为扩展标识符，必须保证生产出的适配器没有重复地址

- 一个地址块可以生成2^24个不同的地址。这种48位地址称为 MAC-48，它的通用名称是EUI-48

- “MAC地址”实际上就是适配器地址或适配器标识符 EUI-48

**适配器检查MAC地址**
适配器从网络上每收到一个MAC帧就首先用硬件检查 MAC 帧中的 MAC 地址

- 如果是发往本站的帧则收下，然后再进行其他的处理

- 否则就将此帧丢弃，不再进行其他的处理

“发往本站的帧”包括以下三种帧：

- 单播（unicast）帧（一对一）

- 广播（broadcast）帧（一对全体）

- 多播（multicast）帧（一对多）

**MAC帧格式**
常用以太网MAC帧格式有两种标准：

- DIX Ethernet V2 标准（最常用）

- IEEE 802.3 标准

**扩展以太网**

- 光纤

- 集线器级联，效率降低

**网桥：**优化以太网（提升效率）

- 在数据链路层扩展局域网是使用网桥

- 网桥工作在数据链路层，它根据 MAC 帧的目的地址对收到的帧进行转发

- 网桥具有过滤帧的功能，当网桥收到一个帧时，并不是向所有的接口转发此帧，而是先检查此帧的目的 MAC 地址，然后再确定将该帧转发到哪一个接口

- 后来发展为交换机（更安全，快速，独享带宽）是局域网主流设备

**网桥的优点：**

- 过滤通信量
- 扩大了物理范围
- 提高了可靠性
- 可互联不同物理层，不同MAC子层和不同速率（如10M/s,和100M/s）的局域网

**网桥的缺点：**

- 存储转发增加时延
- 在MAC子层没有流量控制功能
- 具有不同MAC子层的网段桥接在一起时时延更大
- 只适合用户数不太多（不超过几百个）和通信量不太大的局域网，否则有时候还会因为传播过多的广播信息而产生网络拥塞，这就是所谓的广播风暴

**网桥在转发表中登记以下三个信息：**

- 地址
- 接口
- 帧进入网桥的时间：便于定期更新设备连接情况

**网桥的自学习和转发帧步骤：**

- 收到一帧之后先进行自学习，查找转发表中与收到帧的源地址有无相配的项目，如果没有就在转发表中增加一个项目（源地址，进入接口和时间），如果有，则把原有项目进行更新
- 转发帧，查找转发表中与收到的帧的目的地址有无相配的项目
  - 如没有，则通过所有其他接口（进入网桥的接口除外）进行转发
  - 如有，则按照转发表中给出的接口进行转发
  - 若转发表中给出的接口就是该帧进入网桥的接口，则应丢弃这个帧（因为这时候不需要网桥进行转发）：避免产生转发的帧在网络中不断兜圈子

利用以太网交换机扩展局域网：

- 虚拟局域网 VLAN 是由一些局域网网段构成的与物理位置无关的逻辑组
  - 这些网段具有某些共同的需求
  - 每一个VLAN的帧都有一个明确的标识符，指明发送这个帧的工作站是属于哪一个VLAN
  - 虚拟局域网其实只是局域网给用户提供的一种服务，而并不是一种新型的局域网

## 小结

数据链路层的基本概念和问题：

- 基本概念
- 三个问题
  - 封装成帧
  - 透明传输
  - 差错检验

两种情况下的数据链路层：

- 使用点对点通信的数据链路层
- 使用广播通信的数据链路层

以太局域网（以太网）

扩展以太网

高速以太网
